<!DOCTYPE html>
<html>
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DJango에서 마이그레이션을 하지 말아야 할 데이터베이스를 테스트 하는 방법</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200..900&display=swap">
    <link rel="stylesheet" href="https://spsarolkar.github.io/rouge-theme-preview/css/syntax-gruvbox.dark.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nanum+Gothic+Coding:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&display=swap">

    <link rel="stylesheet" href="https://recoma96.github.io/assets/css/main.css">
    <link rel="stylesheet" href="https://recoma96.github.io/assets/css/mathjax.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
    <body>
        <nav class="
        fixed layout-navbar
        w-full h-16 z-navbar
        text-light-primary-600 dark:text-dark-primary-default
        bg-light-primary-400 dark:bg-zinc-800 bg-opacity-80 backdrop-blur-[2px]
        dark:border-b dark:border-yellow-100
        shadow-navbar-light dark:shadow-navbar-darkq
">
    <div class="
        w-full
        flex justify-between items-center
    ">
        <i id="navbar-menu-button" class="nav-icon bi bi-list text-4xl xl:invisible"></i>

        <a id="navbar-title" href="/posts" class="
            text-lg hidden xl:block cursor-pointer no-underline font-bold text-white dark:text-dark-primary-200
        ">
            Recoma In DEV
        </a>

        <i id="navbar-mode-selector" class="nav-icon bi text-2xl"></i>
    </div>
</nav>

<ul id="navbar-menu" class="
    hidden fixed
    z-30 w-full mt-16 py-6
    bg-white dark:bg-zinc-950
    list-none
    flex flex-col gap-6 text-center
    shadow-navbar-menu
">
    <li class="border-buttom text-[1.2em]"><a class="no-underline text-current" href="/"">Home</a></li>
    <li class="border-buttom text-[1.2em]"><a class="no-underline text-current" href="/posts">Posts</a></li>
    <li class="border-buttom text-[1.2em]"><a class="no-underline text-current" href="/categories">Categories</a></li>
</ul>

        <div class="web-main-container">
            <div id="left-side-bar" class="
    hidden xl:block
    w-[300px] py-[100px] px-6
    bg-white dark:bg-zinc-900
    shadow-layout
">
    <div class="w-full text-center">
        <img src="/assets/img/profile.jpg" width="140px" height="140px"
            class="mx-auto rounded-full" alt="profile"
        />
        <h2 class="font-bold text-rose-400 dark:text-yellow-200">recoma</h2>
        <p>인생 재밌게 사는 방법 탐구중</p>
    </div>

    <div class="sidebar-social-icon-color w-full mt-10 flex flex-wrap justify-center gap-8">
        
<a href="https://github.com/recoma96" class="social-icon text-inherit"><i class="bi bi-github" alt="github"></i></a>



<a href="mailto:seokbong60@gmail.com" class="social-icon text-inherit"><i class="bi bi-envelope-fill" alt="email"></i></a>










    </div>

    <div class="w-full h-[0px] border-b border-zinc-400 mt-8"></div>

    <div class="mt-8 w-full text-center flex flex-col gap-6">
        <a class="text-pink-600 dark:text-dark-text-default font-bold cursor-pointer no-underline" href="/">Home</a>
        <a class="text-violet-600 dark:text-dark-text-default font-bold cursor-pointer no-underline" href="/posts">Posts</a>
        <a class="text-lime-600 dark:text-dark-text-default font-bold cursor-pointer no-underline" href="/categories">Categories</a>
    </div>
</div>
<div class="w-[1px] bg-gray"></div>
            <div class="web-main-item">
                <div class="mb-20">
    <div class="text-center">
        <h2 class="
            px-10 py-4 inline-block
            bg-orange-100 text-orange-600 dark:text-yellow-200
            dark:bg-transparent dark:border-double dark:border dark:border-yellow-200 rounded-md
            shadow-paper-styled
        ">
            DJango에서 마이그레이션을 하지 말아야 할 데이터베이스를 테스트 하는 방법
        </h2>
        <p class="font-semibold"><a href="/categories/#Django" class="no-underline text-orange-700 dark:text-blue-200">Django</a></p>
    </div>
    
    <div class="mt-10">
        <p class="text-[0.8em]">Posted <strong class="no-underline">2024.11.22 16:04</strong></p>
        <p class="text-[0.8em] -mt-2">By <strong class="no-underline">recoma</strong></p>
    </div>

    <div class="
        mt-6 h-[2px] bg-gradient-to-r
        from-white via-lime-400 to-white
        dark:from-zinc-900 dark:via-yellow-200 dark:to-zinc-900
    "></div>
</div>
                <h1 id="개요">개요</h1>

<p>DJango기반의 서비스를 구현할 때, 보통 해당 서비스에 포함되는 데이터베이스 테이블들은 DJango-ORM으로 관리되는 것이 권장되지만. 공용으로 사용되는 데이터베이스 테이블들의 경우 DJango에서 직접 관리되어선 안된다.(ex: 마이그레이션 같은 테이블의 정보를 바꾸는 작업). 이때 migration 작업시, 직접 관리되어선 안되는 테이블들을 마이그레이션 못하게 하기 위해 해당 테이블의 메타 클래스(<code class="language-plaintext highlighter-rouge">class Model.Meta</code>)에 <code class="language-plaintext highlighter-rouge">managed=False</code>로 설정을 하게 된다.</p>

<p><br /></p>

<p>예를 들어 사내 서비스에 대한 어드민 페이지를 개발할 때, 어드민 페이지 내에서 관리하는 어드민 전용 데이터베이스는 어드민 페이지 서버에서 직접 관리해도 문제가 없지만, 서비스 DB를 상대로 어드민 페이지가 절대로 마이그레이션 같은 DDL에 영향을 주는 행위를 절대절대 해서는 안된다. 그렇기 때문에 어드민 페이지 내 서버 코드에서는 서비스 DB와 관련된 모든 Model들을 전부 <code class="language-plaintext highlighter-rouge">managed=False</code> 처리를 해야 한다.</p>

<p><br /></p>

<p>그러나 이는 또 다른 문제를 발생 시키게 되는데, managed=False로 설정된 모델에서는 유닛테스트가 불가능 하다는 점이다. 유닛테스트 작동 시, DJango는 테스트를 수행하기 전에 테스트용 데이터베이스를 생성하고 그 위에 테이블들을 마이그레이션 한다. 그러나 managed=False로 되어 있는 모델들은 마이그레이션이 불가능하므로, 이 시점에서 에러가 발생하고 더이상 테스트를 진행할 수 없게 된다.</p>

<p>이번 포스트에서는 <code class="language-plaintext highlighter-rouge">managed=False</code>로 되어 있는 모델들을 가지고 어떻게 유닛테스트를 할 수 있는지 설명을 하며, 크게 두 가지 방법이 있다.</p>

<h1 id="솔루션">솔루션</h1>

<h2 id="공통사항">공통사항</h2>

<h3 id="auth-user-model-관련">Auth User Model 관련</h3>

<p>두개 이상의 테이블을 사용할 때, 각 테이블의 모델 구조가 다를 때, 정확히는 로그인을 하기 위한 유저 모델이 한군데만 있고 다른 곳에는 없을 때, 유닛테스트 과정에서 문제가 생긴다.</p>

<p><br /></p>

<p>유닛테스트를 진행하기 전에 DJango는 테스트 전용 데이터베이스들을 생성하고 그 데이터베이스 위에 개발자가 작성한 모델들을 토대로 마이그레이션을 진행하게 된다. 이때 생성되는 모델들 중에, 유저가 정의한 모델들 말고 장고 내장의 모델들도 같이 마이그레이션을 하게 되는데, 이 중 <code class="language-plaintext highlighter-rouge">django_admin_log</code> 라는 테이블이 생성을 하면서 유저가 정의한 로그인 용도의 유저 모델(<code class="language-plaintext highlighter-rouge">AUTH_USER_MODEL</code>) 과 릴레이션 진행을 한다. 그러나 유저 모델이 없는 데이터베이스에서는 <code class="language-plaintext highlighter-rouge">django_admin_log</code> 와 릴레이션을 진행할 수 없기 때문에 유닛 테스트를 실행하기 전 에러가 발생하게 된다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">django</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">IntegrityError</span><span class="p">:</span> <span class="p">(</span><span class="mi">1215</span><span class="p">,</span> <span class="sh">'</span><span class="s">Cannot add foreign key constraint</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p>해결 방법은 간단하다. INSTALLED_APPS에 <code class="language-plaintext highlighter-rouge">'django.contrib.admin'</code> 을 주석처리하면 된다.</p>

<p><br /></p>

<p>보통 직접 정의한 모델을  하기 위해 <code class="language-plaintext highlighter-rouge">INSTALLED_APPS</code>에 해당 모델과 관련된 앱 이름을 작성을 하게 된다. <code class="language-plaintext highlighter-rouge">python manage.py migrate</code> 을 수행할 때, 내가 직접 정의한 모델 말고도 장고 내장 테이블도 같이 마이그레이션 되는데, <strong>이는 직접 하드코딩 된 것이 아니라 장고 내장 테이블을 포함하고 있는 모듈이 <code class="language-plaintext highlighter-rouge">INSTALLED_APPS</code>에 선언되어 있기 때문에 저절로 같이 마이그레이션 된 것이다.</strong></p>

<p><br /></p>

<p><code class="language-plaintext highlighter-rouge">django_admin_log</code>도 마찬가지로 <code class="language-plaintext highlighter-rouge">django.contrib.admin</code> 안에 포함되어 있기 때문에 마이그레이션 된 것이다. 따라서 반대로 <code class="language-plaintext highlighter-rouge">django.contrib.admin</code>을 주석처리 및 제외를 하게 되면 <code class="language-plaintext highlighter-rouge">django_admin_log</code>를 더이상 마이그레이션을 하지 않게 될 것이고, 이에 따른 왜래키 문제도 더이상 발생하지 않게 된다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># 'django.contrib.admin'
</span>    <span class="sh">'</span><span class="s">django.contrib.auth</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">django.contrib.contenttypes</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">django.contrib.sessions</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">django.contrib.messages</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">django.contrib.staticfiles</span><span class="sh">'</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div></div>

<h2 id="무식한-방법-djangosettings를-활용해-테스트-할-때만-mangedtrue로-변경하기">(무식한 방법) django.settings를 활용해 테스트 할 때만 manged=True로 변경하기</h2>

<h3 id="적용-방법">적용 방법</h3>

<ol>
  <li>settings.py에 TEST를 진행중인지에 대한 여부를 나타내는 환경변수를 추가한다.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">UNDER_TEST</span> <span class="o">=</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>managed = False상태인 모든 모델의 메타 클래스의 managed를 <strong>전부 다</strong> 아래와 같이 변경한다.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
     <span class="n">db_table</span> <span class="o">=</span> <span class="sh">"</span><span class="s">example_table</span><span class="sh">"</span>
     <span class="n">managed</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="sh">"</span><span class="s">UNDER_TEST</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>대상 DB모델을 호출하는 테스트 스크립트를 작성해서 정상적으로 테스트가 돌아가는 지 확인한다.</li>
</ol>

<h3 id="문제점">문제점</h3>

<p>각 <code class="language-plaintext highlighter-rouge">Model.Meta</code>마다 <code class="language-plaintext highlighter-rouge">getattr</code>함수를 작성해야 하기 때문에 코드 가시성이 떨어지고 유지보수에 문제가 생긴다. 따라서 해당 방안은 비권장하는 부분이다.</p>

<h2 id="test-runner-활용하기">Test Runner 활용하기</h2>

<p>위의 방법과 마찬가지로 <code class="language-plaintext highlighter-rouge">manged = True</code>로 바꿔야 한다는 방향은 일치하지만, 위의 방법에 비해 기술 부채가 일어나지 않게 진행하는 해결방안이다.</p>

<p><br /></p>

<p><code class="language-plaintext highlighter-rouge">DiscoverRunner</code>를 상속받아서 테스트가 맨 처음에 시작했을 때 managed를 True로 바꾸고, 끝나면 다시 원래대로 돌려놓게 함수를 오버라이딩 함으로써, Model 클래스에 위와 같이 똑같은 코드 작성 필요 없이 깔끔하게 해결할 수 있다.</p>

<h3 id="testrunner">TestRunner</h3>

<blockquote>
  <p>A test runner is a class defining a run_tests() method. Django ships with a DiscoverRunner class that defines the default Django testing behavior. This class defines the run_tests() entry point, plus a selection of other methods that are used by run_tests() to set up, execute and tear down the test suite.</p>
</blockquote>

<p>TestRunner는 유닛테스트의 작동 방식을 정의를 한다. 각 TestCase 마다 작동 방식을 정의하는 함수들(setUpClass, setUp 등…)과는 다르게 <strong>전체적인 작동 방식을 정의한다.</strong> 예를 들어, 모든 테스트 케이스에서 공통적으로 사용할 수 있는 환경변수를 정의할 수도 있고, 데이터베이스 모델 정보도 변경할 수 있으며, 마이그레이션 없이 테스트를 진행하게 수정할 수 있다. 즉, <strong>TestCase에서는 할 수 없는 정밀한 작업 프로세스를 여기서 구현할 수 있다.</strong></p>

<p>보통 <code class="language-plaintext highlighter-rouge">django.test.runner.DiscoverRunner</code>를 상속받아서 사용한다.</p>

<h3 id="오버라이딩-할-수-있는-함수들">오버라이딩 할 수 있는 함수들</h3>

<p><code class="language-plaintext highlighter-rouge">setup_test_environment()</code></p>

<ul>
  <li>막 테스트가 시작될 때 작동하는 함수, 모델들을 <code class="language-plaintext highlighter-rouge">managed=True</code>로 변경하는 로직을 여기서 구현한다.</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">teardown_test_environment()</code></p>

<ul>
  <li>모든 테스트 케이스가 끝나면 작동되는 함수, managed정보가 변경된 모델들을 원상복귀할 때 사용된다.</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">setup_databases()</code></p>

<ul>
  <li>테스트용 데이터베이스를 생성하고, 마이그레이션을 하는 등, 테스트에 사용되는 데이터베이스들을 세팅하는 데 사용된다.</li>
  <li>테스트용 데이터베이스를 생성하는 것을 원하지 않는다면 함수내용을 비우는 방향으로 오버라이딩 하면 된다.</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">teardown_databases()</code></p>

<ul>
  <li>테스트용 데이터베이스를 거두는 등, DB 환경을 원상복귀 시키는데 사용된다.</li>
</ul>

<h3 id="run_tests"><code class="language-plaintext highlighter-rouge">run_tests()</code></h3>

<p>모든 테스트케이스가 돌아갈 수 있는 이유는 <code class="language-plaintext highlighter-rouge">run_tests</code>함수가 실행되기 때문이다. run_tests의 로직은 아래와 같다.</p>

<ol>
  <li>테스트가 시작되기 전 전처리 수행 <code class="language-plaintext highlighter-rouge">setup_test_environment()</code></li>
  <li>테스트 케이스 수집 <code class="language-plaintext highlighter-rouge">build_suite()</code></li>
  <li>테스트용 데이터베이스 수집 및 세팅 <code class="language-plaintext highlighter-rouge">get_databases()</code>, <code class="language-plaintext highlighter-rouge">setup_databases()</code></li>
  <li><strong>테스트 수행</strong> <code class="language-plaintext highlighter-rouge">run_suite()</code>
    <ul>
      <li>test실패 (assert)시 exception 호출</li>
    </ul>
  </li>
  <li>테스트 종료 후 프로세스 수행 <code class="language-plaintext highlighter-rouge">teardown_databases()</code> <code class="language-plaintext highlighter-rouge">teardown_test_environment()</code>
    <ul>
      <li>테스트실패 여부 상관업싱 해당 로직은 수행된다.</li>
    </ul>
  </li>
</ol>

<ul>
  <li><code class="language-plaintext highlighter-rouge">run_tests()</code> 코드 전문</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">,</span> <span class="n">extra_tests</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Run the unit tests for all the test labels in the provided list.

    Test labels should be dotted Python paths to test modules, test
    classes, or test methods.

    Return the number of tests that failed.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">extra_tests</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span>
            <span class="sh">"</span><span class="s">The extra_tests argument is deprecated.</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">RemovedInDjango50Warning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="nf">setup_test_environment</span><span class="p">()</span>
    <span class="n">suite</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">build_suite</span><span class="p">(</span><span class="n">test_labels</span><span class="p">,</span> <span class="n">extra_tests</span><span class="p">)</span>
    <span class="n">databases</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_databases</span><span class="p">(</span><span class="n">suite</span><span class="p">)</span>
    <span class="n">suite</span><span class="p">.</span><span class="n">serialized_aliases</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span>
        <span class="n">alias</span> <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">serialize</span> <span class="ow">in</span> <span class="n">databases</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">serialize</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">time_keeper</span><span class="p">.</span><span class="nf">timed</span><span class="p">(</span><span class="sh">"</span><span class="s">Total database setup</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">old_config</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">setup_databases</span><span class="p">(</span>
            <span class="n">aliases</span><span class="o">=</span><span class="n">databases</span><span class="p">,</span>
            <span class="n">serialized_aliases</span><span class="o">=</span><span class="n">suite</span><span class="p">.</span><span class="n">serialized_aliases</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">run_failed</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">run_checks</span><span class="p">(</span><span class="n">databases</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_suite</span><span class="p">(</span><span class="n">suite</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">run_failed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">time_keeper</span><span class="p">.</span><span class="nf">timed</span><span class="p">(</span><span class="sh">"</span><span class="s">Total database teardown</span><span class="sh">"</span><span class="p">):</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">teardown_databases</span><span class="p">(</span><span class="n">old_config</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">teardown_test_environment</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># Silence teardown exceptions if an exception was raised during
</span>            <span class="c1"># runs to avoid shadowing it.
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">run_failed</span><span class="p">:</span>
                <span class="k">raise</span>
    <span class="n">self</span><span class="p">.</span><span class="n">time_keeper</span><span class="p">.</span><span class="nf">print_results</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">suite_result</span><span class="p">(</span><span class="n">suite</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="적용-방법-1">적용 방법</h3>
<ol>
  <li>DiscoverRunner를 상속받는 모듈을 작성한다.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">setup_test_environment</code>
        <ul>
          <li><strong>테스트가 본격적으로 시작하기 전에 딱 한번 실행되는 함수</strong>로 <code class="language-plaintext highlighter-rouge">TestCase</code>가 처음 실행될 때 작동하는 <code class="language-plaintext highlighter-rouge">setUpClass</code>나 <code class="language-plaintext highlighter-rouge">setUpTestData</code> 와는 결이 다르다</li>
        </ul>
      </li>
      <li><code class="language-plaintext highlighter-rouge">teardown_test_environment</code>
        <ul>
          <li><strong>모든 테스트 케이스가 다 끝나는 순간에 작동되는 함수</strong></li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Set</span>

<span class="kn">from</span> <span class="n">django.test.runner</span> <span class="kn">import</span> <span class="n">DiscoverRunner</span>
<span class="kn">from</span> <span class="n">django.apps</span> <span class="kn">import</span> <span class="n">apps</span>


<span class="k">class</span> <span class="nc">UnManagedModelTestRunner</span><span class="p">(</span><span class="n">DiscoverRunner</span><span class="p">):</span>
    <span class="n">un_managed_models</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">un_managed_models</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup_test_environment</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">apps</span><span class="p">.</span><span class="nf">get_models</span><span class="p">():</span>
            <span class="n">model_name</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">_meta</span><span class="p">.</span><span class="n">model_name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">.</span><span class="n">_meta</span><span class="p">.</span><span class="n">managed</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">un_managed_models</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
                <span class="n">model</span><span class="p">.</span><span class="n">_meta</span><span class="p">.</span><span class="n">managed</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="nf">super</span><span class="p">(</span><span class="n">UnManagedModelTestRunner</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">setup_test_environment</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">teardown_test_environment</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">apps</span><span class="p">.</span><span class="nf">get_models</span><span class="p">():</span>
            <span class="n">model_name</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">_meta</span><span class="p">.</span><span class="n">model_name</span>
            <span class="k">if</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">un_managed_models</span><span class="p">:</span>
                <span class="n">model</span><span class="p">.</span><span class="n">_meta</span><span class="p">.</span><span class="n">managed</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="nf">super</span><span class="p">(</span><span class="n">UnManagedModelTestRunner</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">teardown_test_environment</span><span class="p">()</span>
</code></pre></div></div>

<ol>
  <li><code class="language-plaintext highlighter-rouge">settings.py</code>에 <code class="language-plaintext highlighter-rouge">TEST_RUNNER</code> 변수를 추가한다.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">TEST_RUNNER</span> <span class="o">=</span> <span class="sh">"</span><span class="s">api.tests.runner.UnManagedModelTestRunner</span><span class="sh">"</span>
</code></pre></div></div>

<ol>
  <li>유닛테스트를 실행해 제대로 작동되는 지 확인한다.</li>
</ol>

<h1 id="references">References</h1>

<ul>
  <li><a href="https://yangtaeyoung.github.io/docs/django/unmanaged-model/#soluton-1-%EB%AA%85%EB%A0%B9%EC%96%B4-%EA%B0%80%EB%A1%9C%EC%B1%84%EA%B8%B0%EC%A0%9C%EA%B0%80-%EC%82%AC%EC%9A%A9%ED%95%9C-%EB%B0%A9%EB%B2%95">Unmanaged Model을 사용하면서 Test를 적용하기(feat. Table XXX doesn’t exist)</a></li>
  <li><a href="https://technote.fyi/programming/django/django-database-testing-unmanaged-tables-with-migrations/">Django Database Testing Unmanaged Tables with Migration</a></li>
  <li><a href="https://docs.djangoproject.com/en/5.0/topics/testing/advanced/">Django Testing Advanced Document</a></li>
  <li><a href="https://docs.djangoproject.com/en/5.0/ref/applications/">Django Applications Document</a></li>
</ul>


                <div class="
                    mt-6 h-[2px] bg-gradient-to-r
                    from-white via-cyan-400 to-white
                    dark:from-zinc-900 dark:via-yellow-200 dark:to-zinc-900
                "></div>
                <div class="px-4 py-4 flex flex-wrap justify-start gap-x-2.5 gap-y-1.5">
                    
                    <a class="tag" href="/tags/#python">python</a>
                    
                    <a class="tag" href="/tags/#django">django</a>
                    
                    <a class="tag" href="/tags/#database">database</a>
                    
                    <a class="tag" href="/tags/#unittest">unittest</a>
                    
                </div>

                <script src="https://utteranc.es/client.js"
                    repo="recoma96/recoma96.github.io"
                    issue-term="url"
                    label="blog"
                    theme="github-light"
                    crossorigin="anonymous"
                    async>
                </script>
            </div>
        </div>

        <div class="
    absolute xl:px-[140px] px-mobileX
    w-full bottom-0 flex flex-col pb-10
    text-ornage-800 text-sm text-white font-footer
    bg-lime-600 dark:bg-zinc-900 bg-opacity-80
    dark:border-t shadow-footer-light
    z-footer
">
    <div class="w-full flex flex-wrap justify-center gap-6 mt-6 xl:hidden">
        
<a href="https://github.com/recoma96" class="social-icon text-inherit"><i class="bi bi-github" alt="github"></i></a>



<a href="mailto:seokbong60@gmail.com" class="social-icon text-inherit"><i class="bi bi-envelope-fill" alt="email"></i></a>










    </div>
    <div class="leading-relaxed justify-between mt-6 flex">
        <div>
            <p>Designed by <a href="https://github.com/recoma96" class="no-underline text-blue-800 dark:text-yellow-200">recoma96</a></p>
            <p>Theme by <a href="https://github.com/recoma96/lollineon" class="no-underline text-blue-800 dark:text-yellow-200">LolliNeon</a></p>
        </div>
        <p>Powered by <a href="https://jekyllrb.com/docs/themes" class="no-underline text-blue-800 dark:text-yellow-200">jekyll</a></p>
    </div>
</div>
        <script type="text/javascript" src="https://code.jquery.com/jquery-latest.min.js"></script>
<script type="text/javascript" src="https://recoma96.github.io/assets/js/util.js"></script>
<script type="text/javascript" src="https://recoma96.github.io/assets/js/layout.js"></script>
<script type="text/javascript" src="https://recoma96.github.io/assets/js/navbar.js"></script>
    </body>
</html>