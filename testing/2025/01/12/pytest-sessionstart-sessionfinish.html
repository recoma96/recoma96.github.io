<!DOCTYPE html>
<html>
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pytest에서 테스트 처음과 끝부분에 프로세스를 작성하는 법</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200..900&display=swap">
    <link rel="stylesheet" href="https://spsarolkar.github.io/rouge-theme-preview/css/syntax-gruvbox.dark.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nanum+Gothic+Coding:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&display=swap">

    <link rel="stylesheet" href="https://recoma96.github.io/assets/css/main.css">
    <link rel="stylesheet" href="https://recoma96.github.io/assets/css/mathjax.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
    <body>
        <nav class="
        fixed layout-navbar
        w-full h-16 z-navbar
        text-light-primary-600 dark:text-dark-primary-default
        bg-light-primary-400 dark:bg-zinc-800 bg-opacity-80 backdrop-blur-[2px]
        dark:border-b dark:border-yellow-100
        shadow-navbar-light dark:shadow-navbar-darkq
">
    <div class="
        w-full
        flex justify-between items-center
    ">
        <i id="navbar-menu-button" class="nav-icon bi bi-list text-4xl xl:invisible"></i>

        <a id="navbar-title" href="/posts" class="
            text-lg hidden xl:block cursor-pointer no-underline font-bold text-white dark:text-dark-primary-200
        ">
            Recoma In DEV
        </a>

        <i id="navbar-mode-selector" class="nav-icon bi text-2xl"></i>
    </div>
</nav>

<ul id="navbar-menu" class="
    hidden fixed
    z-30 w-full mt-16 py-6
    bg-white dark:bg-zinc-950
    list-none
    flex flex-col gap-6 text-center
    shadow-navbar-menu
">
    <li class="border-buttom text-[1.2em]"><a class="no-underline text-current" href="/posts">Posts</a></li>
    <li class="border-buttom text-[1.2em]"><a class="no-underline text-current" href="/categories">Categories</a></li>
    <li class="border-buttom text-[1.2em]"><a class="no-underline text-current" href="/about"">About</a></li>
</ul>

        <div class="web-main-container">
            <div id="left-side-bar" class="
    hidden xl:block
    w-[300px] py-[100px] px-6
    bg-white dark:bg-zinc-900
    shadow-layout
">
    <div class="w-full text-center">
        <img src="/assets/img/profile.jpg" width="140px" height="140px"
            class="mx-auto rounded-full" alt="profile"
        />
        <h2 class="font-bold text-rose-400 dark:text-yellow-200">recoma</h2>
        <p>인생 재밌게 사는 방법 탐구중</p>
    </div>

    <div class="w-full mt-10 flex flex-wrap justify-center gap-8">
        
<a href="https://github.com/recoma96" class="social-icon text-inherit"><i class="bi bi-github social-icon-color" alt="github"></i></a>



<a href="mailto:seokbong60@gmail.com" class="social-icon text-inherit"><i class="bi bi-envelope-fill social-icon-color" alt="email"></i></a>










    </div>

    <div class="w-full h-[0px] border-b border-zinc-400 mt-8"></div>

    <div class="mt-8 w-full text-center flex flex-col gap-6">
        <a class="text-pink-600 dark:text-dark-text-default font-bold cursor-pointer no-underline" href="/posts">Posts</a>
        <a class="text-lime-600 dark:text-dark-text-default font-bold cursor-pointer no-underline" href="/categories">Categories</a>
        <a class="text-violet-600 dark:text-dark-text-default font-bold cursor-pointer no-underline" href="/about">About</a>
    </div>
</div>
<div class="w-[1px] bg-gray"></div>
            <div class="web-main-item">
                <div class="mb-20">
    <div class="text-center">
        <h2 class="
            px-10 py-4 inline-block
            bg-orange-100 text-orange-600 dark:text-yellow-200
            dark:bg-transparent dark:border-double dark:border dark:border-yellow-200 rounded-md
            shadow-paper-styled
        ">
            Pytest에서 테스트 처음과 끝부분에 프로세스를 작성하는 법
        </h2>
        <p class="font-semibold"><a href="/categories/#Testing" class="no-underline text-orange-700 dark:text-blue-200">Testing</a></p>
    </div>
    
    <div class="mt-10">
        <p class="text-[0.8em]">Posted <strong class="no-underline">2025.01.12 23:30</strong></p>
        <p class="text-[0.8em] -mt-2">By <strong class="no-underline">recoma</strong></p>
    </div>

    <div class="
        mt-6 h-[2px] bg-gradient-to-r
        from-white via-lime-400 to-white
        dark:from-zinc-900 dark:via-yellow-200 dark:to-zinc-900
    "></div>

    
</div>
                <h1 id="개요">개요</h1>

<p>이전에 <a href="https://recoma96.github.io/django/2024/11/22/django-unittest-set-migration-with-other-db.html">DJango에서 테스트 코드 작성 시 마이그레이션을 하지 말아야 할 데이터베이스 사용법</a> 에서 <code class="language-plaintext highlighter-rouge">DiscoverRunner</code>를 사용하면 맨 처음과 맨 마지막의 로직을 작성함으로써 테스트 시작 전 여러 세팅들을 할 수 있다고 언급했다. 그렇다면, pytest에도 이러한 툴이 있을 까?</p>

<h1 id="fixture">fixture</h1>

<p>이번에 설명할 툴에 대해서 언급하기 전에 fixture부터 설명해야 할 필요가 있다. pytest에서의 fixture는 테스트 함수 간에 공유할 수 있는 상태나 데이터를 제공하는 기능이다. 예를 들어 테스트를 하면서 유저 정보가 담긴 Dict 형태의 데이터가 사전에 필요하다면 아래와 같이 구현하면 된다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nd">@fixture</span>
<span class="k">def</span> <span class="nf">user</span><span class="p">():</span>
    <span class="n">user_data</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">recoma</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">birthday</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">19990101</span><span class="sh">"</span><span class="p">}</span>
    <span class="nf">insert_to_database</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>
    
    <span class="k">yield</span> <span class="n">user_data</span>

    <span class="nf">remove_from_database</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_about_user</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="c1"># Do something
</span></code></pre></div></div>

<p>해당 테스트 코드의 순서는 아래와 같다.</p>
<ol>
  <li><code class="language-plaintext highlighter-rouge">test_about_user()</code>가 작동하기 전에 <code class="language-plaintext highlighter-rouge">user()</code>가 작동한다.</li>
  <li><code class="language-plaintext highlighter-rouge">user()</code>에서 user_data를 리턴한다. 이 리턴된 데이터는 <code class="language-plaintext highlighter-rouge">test_about_user</code>의 <code class="language-plaintext highlighter-rouge">user</code>라는 파라미터에 들어간다.</li>
  <li><code class="language-plaintext highlighter-rouge">test_about_user()</code>는 <code class="language-plaintext highlighter-rouge">user</code>를 이용해서 특정 테스트를 진행한다.</li>
  <li><code class="language-plaintext highlighter-rouge">test_about_user()</code>의 프로세스가 끝나면 <code class="language-plaintext highlighter-rouge">user()</code>의 <code class="language-plaintext highlighter-rouge">yield</code>의 아랫부분이 작동한다.</li>
</ol>

<p><br /></p>

<p>이렇게 fixture는 테스팅을 하기 위해 필요한 데이터들을 미리 세팅하고 테스트 함수들에게 그 데이터를 제공하는데 유용하게 쓰인다. 이런 특성을 이용해 테스트를 세팅할 때도 사용되곤 한다.</p>

<h2 id="한계">한계</h2>

<p>그러나 이 fixture 사용에도 한계가 있다.</p>

<h3 id="scope-범위">scope 범위</h3>

<p>fixture에는 scope라고 해서 작동 범위를 설정하는 파라미터가 있다. 선언 방법은 아래와 같다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>이는 매 테스트 함수(케이스)가 작동될 때마다 해당 함수가 작동됨을 의미한다. scope를 <code class="language-plaintext highlighter-rouge">module</code>로 설정 할 경우 테스트 파일 내 에서만 작동이 되고 <code class="language-plaintext highlighter-rouge">session</code>으로 설정하면 모든 테스트 파일에서 딱 한번만 작동한다. 일단 <code class="language-plaintext highlighter-rouge">module</code>과, <code class="language-plaintext highlighter-rouge">function</code>은 전체 테스트 에서 딱 한번 실행되는게 아니기 때문에 사용하는데 한계가 있다. <code class="language-plaintext highlighter-rouge">session</code>이 그나마 쓸만해 보이지만 이건 이거대로 문제가 있는데. <code class="language-plaintext highlighter-rouge">session</code>으로 설정된 fixture를 사용하기 위해, <strong>매 함수 또는 일부 함수의 파라미터에다가 해당 fixture를 명시해야 한다.</strong> 단순해 보이지만 이는 일일이 코드가 하나씩 추가됨으로써 클린 코드 상 좋지 못한 결과를 보여줄 수 있다.</p>

<h1 id="pytest_session">pytest_session*</h1>

<p>그렇기 때문에 pytest에서는 아예 테스트 실행과 끝나는 시점에 로직을 작성할 수 있도록 인터페이스를 제공해 주는 데 이게 바로 <code class="language-plaintext highlighter-rouge">pytest_sessionstart</code>와 <code class="language-plaintext highlighter-rouge">pytest_sessionfinish</code>이다. 이 둘을 사용하면 <code class="language-plaintext highlighter-rouge">fixture</code>와 각 테스트 함수에 일일이 설정하지 않아도 알아서 잘 돌아간다. 이 두 함수들은 말 그대로 맨 처음에서 부터 시작하기 때문에 특정 테스트 파일에 들어가기 보다는 <code class="language-plaintext highlighter-rouge">conftest.py</code>에 작성이 되는 경우가 더 많다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># conftest.py
</span>
<span class="k">def</span> <span class="nf">pytest_sessionstart</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">_pytest</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">Session</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Start</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">pytest_sessionfinish</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">_pytest</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">Session</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Finish!</span><span class="sh">"</span><span class="p">)</span>


<span class="c1"># test_example.py
</span>
<span class="k">def</span> <span class="nf">test_example</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Testing</span><span class="sh">"</span><span class="p">)</span>

</code></pre></div></div>


                <div class="
                    mt-6 h-[2px] bg-gradient-to-r
                    from-white via-cyan-400 to-white
                    dark:from-zinc-900 dark:via-yellow-200 dark:to-zinc-900
                "></div>
                <div class="px-4 py-4 flex flex-wrap justify-start gap-x-2.5 gap-y-1.5">
                    
                    <a class="tag" href="/tags/#python">python</a>
                    
                    <a class="tag" href="/tags/#testing">testing</a>
                    
                    <a class="tag" href="/tags/#pytest">pytest</a>
                    
                </div>

                <script src="https://utteranc.es/client.js"
                    repo="recoma96/recoma96.github.io"
                    issue-term="url"
                    label="blog"
                    theme="github-light"
                    crossorigin="anonymous"
                    async>
                </script>
            </div>
        </div>

        <div class="
    absolute xl:px-[140px] px-mobileX
    w-full bottom-0 flex flex-col pb-10
    text-ornage-800 text-sm text-white font-footer
    bg-lime-600 dark:bg-zinc-900 bg-opacity-80
    dark:border-t shadow-footer-light
    z-footer
">
    <div class="w-full flex flex-wrap justify-center gap-6 mt-6 xl:hidden">
        
<a href="https://github.com/recoma96" class="social-icon text-inherit"><i class="bi bi-github social-icon-color" alt="github"></i></a>



<a href="mailto:seokbong60@gmail.com" class="social-icon text-inherit"><i class="bi bi-envelope-fill social-icon-color" alt="email"></i></a>










    </div>
    <div class="leading-relaxed justify-between mt-6 flex">
        <div>
            <p>Designed by <a href="https://github.com/recoma96" class="no-underline text-blue-800 dark:text-yellow-200">recoma96</a></p>
            <p>Theme by <a href="https://github.com/recoma96/lollineon" class="no-underline text-blue-800 dark:text-yellow-200">LolliNeon</a></p>
        </div>
        <p>Powered by <a href="https://jekyllrb.com/docs/themes" class="no-underline text-blue-800 dark:text-yellow-200">jekyll</a></p>
    </div>
</div>
        <script type="text/javascript" src="https://code.jquery.com/jquery-latest.min.js"></script>
<script type="text/javascript" src="https://recoma96.github.io/assets/js/util.js"></script>
<script type="text/javascript" src="https://recoma96.github.io/assets/js/layout.js"></script>
<script type="text/javascript" src="https://recoma96.github.io/assets/js/navbar.js"></script>
    </body>
</html>